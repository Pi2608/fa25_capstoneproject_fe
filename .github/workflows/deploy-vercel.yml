name: Deploy to Vercel

on:
  push:
    branches:
      - main
      - nhi
      - dat
      - merge-backup

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js
        run: npm run build

      - name: Deploy to Vercel
        id: vercel
        run: |
          npm install -g vercel@latest
          
          if [ "${GITHUB_REF##*/}" = "main" ]; then
            echo "ğŸš€ Deploying PRODUCTION build..."
            DEPLOY_URL=$(vercel --prod --confirm \
              --token ${{ secrets.VERCEL_TOKEN }} \
              --org-id ${{ secrets.VERCEL_ORG_ID }} \
              --project-id ${{ secrets.VERCEL_PROJECT_ID }} \
              2>/dev/null | tail -n 1)
          else
            echo "ğŸš§ Deploying PREVIEW build for branch: ${GITHUB_REF##*/}..."
            DEPLOY_URL=$(vercel --confirm \
              --token ${{ secrets.VERCEL_TOKEN }} \
              --org-id ${{ secrets.VERCEL_ORG_ID }} \
              --project-id ${{ secrets.VERCEL_PROJECT_ID }} \
              2>/dev/null | tail -n 1)
          fi
          
          # Validate deployment URL
          if [ -z "$DEPLOY_URL" ]; then
            echo "âŒ Deployment failed - no URL returned"
            exit 1
          fi
          
          # Clean URL (remove any extra whitespace or characters)
          DEPLOY_URL=$(echo "$DEPLOY_URL" | tr -d '[:space:]')
          
          echo "âœ… Deployment successful!"
          echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT

      - name: Show Deployment URL
        run: |
          echo "ğŸ”— Deployed to: ${{ steps.vercel.outputs.deploy_url }}"
          echo "ğŸ“± Branch: ${GITHUB_REF##*/}"
          echo "ğŸ”„ Commit: ${GITHUB_SHA:0:7}"

      - name: Comment on PR (if applicable)
        if: github.event_name == 'push' && github.ref != 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const deployUrl = '${{ steps.vercel.outputs.deploy_url }}';
            const branch = context.ref.replace('refs/heads/', '');
            const commit = context.sha.substring(0, 7);
            
            // Find open PR for this branch
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });
            
            if (pulls.length > 0) {
              const pr = pulls[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `ğŸš€ **Preview Deployment Ready!**
                
                ğŸ“± **Branch:** \`${branch}\`
                ğŸ”„ **Commit:** \`${commit}\`
                ğŸ”— **Preview URL:** ${deployUrl}
                
                The latest changes have been deployed and are ready for review!`
              });
            }